<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> fastjson序列化关于get方法 · sky</title><meta name="description" content="fastjson序列化关于get方法 - 席江平"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/sky.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="sky"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/sky.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://soccer.hupu.com" target="_blank" class="nav-list-link">SOCCER</a></li><li class="nav-list-item"><a href="https://github.com/falseor" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">fastjson序列化关于get方法</h1><div class="post-info">Sep 27, 2017</div><div class="post-content"><h1 id="fastjson-序列化关于get问题"><a href="#fastjson-序列化关于get问题" class="headerlink" title="fastjson 序列化关于get问题"></a>fastjson 序列化关于get问题</h1><p>@(get)[typeutil|ASMSerializerFactory|SerializeConfig]</p>
<p><strong>fastjson</strong>是一个高性能的java序列化工具，通常打日志或者序列化json都会使用到。昨天在开发过程中遇到一个问题，一个bean对象在序列化字符串之后里面的一个枚举属性被改变了。之后就跟踪看了一下源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">SerializeWriter out = <span class="keyword">new</span> SerializeWriter(<span class="keyword">null</span>, defaultFeatures, features);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            JSONSerializer serializer = <span class="keyword">new</span> JSONSerializer(out, config);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (dateFormat != <span class="keyword">null</span> &amp;&amp; dateFormat.length() != <span class="number">0</span>) &#123;</div><div class="line">                serializer.setDateFormat(dateFormat);</div><div class="line">                serializer.config(SerializerFeature.WriteDateUseDateFormat, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (filters != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (SerializeFilter filter : filters) &#123;</div><div class="line">                    serializer.addFilter(filter);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            serializer.write(object);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> out.toString();</div></pre></td></tr></table></figure>
<p>这里面先生成了一个SerializeWriter对象，再用它生成了 jsonserializer的类，然后再写对象。来看看这个write方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public final void write(Object object) &#123;</div><div class="line">      if (object == null) &#123;</div><div class="line">          out.writeNull();</div><div class="line">          return;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Class&lt;?&gt; clazz = object.getClass();</div><div class="line">      ObjectSerializer writer = getObjectWriter(clazz);</div><div class="line"></div><div class="line">      try &#123;</div><div class="line">          writer.write(this, object, null, null, 0);</div><div class="line">      &#125; catch (IOException e) &#123;</div><div class="line">          throw new JSONException(e.getMessage(), e);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>在这个方法里主要是 生成 ObjectSerializer 对象，然后再写，我们追踪生成ObjectSerializer对象的方法</p>
<p>JSONSerializer  328行<br>SerializeConfig 377行  380行 444行  123行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private final ObjectSerializer createJavaBeanSerializer(Class&lt;?&gt; clazz) &#123;</div><div class="line">	    SerializeBeanInfo beanInfo = TypeUtils.buildBeanInfo(clazz, null, propertyNamingStrategy);</div><div class="line">	    if (beanInfo.fields.length == 0 &amp;&amp; Iterable.class.isAssignableFrom(clazz)) &#123;</div><div class="line">	        return MiscCodec.instance;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    return createJavaBeanSerializer(beanInfo);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>TypeUtils.buildBeanInfo()方法里面要构造要序列化的bean的信息。截取里面部分关键代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// fieldName,field ，先生成fieldName的快照，减少之后的findField的轮询</div><div class="line">      Map&lt;String, Field&gt; fieldCacheMap = new HashMap&lt;String, Field&gt;();</div><div class="line">      ParserConfig.parserAllFieldToCache(beanType, fieldCacheMap);</div><div class="line"></div><div class="line">      List&lt;FieldInfo&gt; fieldInfoList = computeGetters(beanType, jsonType, aliasMap, fieldCacheMap, false, propertyNamingStrategy);</div><div class="line">      FieldInfo[] fields = new FieldInfo[fieldInfoList.size()];</div><div class="line">      fieldInfoList.toArray(fields);</div><div class="line">      </div><div class="line">      String[] orders = null;</div></pre></td></tr></table></figure></p>
<p>computeGetters()方法会获取bean里面所有的字段。<br>再截取里面部分代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div></pre></td><td class="code"><pre><div class="line">if (methodName.startsWith(&quot;get&quot;)) &#123;</div><div class="line">               if (methodName.length() &lt; 4) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               if (methodName.equals(&quot;getClass&quot;)) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               if (methodName.equals(&quot;getDeclaringClass&quot;) &amp;&amp; clazz.isEnum()) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               char c3 = methodName.charAt(3);</div><div class="line"></div><div class="line">               String propertyName;</div><div class="line">               if (Character.isUpperCase(c3) //</div><div class="line">                   || c3 &gt; 512 // for unicode method name</div><div class="line">               ) &#123;</div><div class="line">                  if (compatibleWithJavaBean) &#123;</div><div class="line">                       propertyName = decapitalize(methodName.substring(3));</div><div class="line">                   &#125; else &#123;</div><div class="line">                       propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</div><div class="line">                   &#125;</div><div class="line">                   propertyName = getPropertyNameByCompatibleFieldName(fieldCacheMap, methodName,  propertyName,3); </div><div class="line">               &#125; else if (c3 == &apos;_&apos;) &#123;</div><div class="line">                   propertyName = methodName.substring(4);</div><div class="line">               &#125; else if (c3 == &apos;f&apos;) &#123;</div><div class="line">                   propertyName = methodName.substring(3);</div><div class="line">               &#125; else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) &#123;</div><div class="line">                   propertyName = decapitalize(methodName.substring(3));</div><div class="line">               &#125; else &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               boolean ignore = isJSONTypeIgnore(clazz, propertyName);</div><div class="line"></div><div class="line">               if (ignore) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line">               //假如bean的field很多的情况一下，轮询时将大大降低效率</div><div class="line">               Field field = ParserConfig.getFieldFromCache(propertyName, fieldCacheMap);</div><div class="line">               </div><div class="line">               if (field == null &amp;&amp; propertyName.length() &gt; 1) &#123;</div><div class="line">                   char ch = propertyName.charAt(1);</div><div class="line">                   if (ch &gt;= &apos;A&apos; &amp;&amp; ch &lt;= &apos;Z&apos;) &#123;</div><div class="line">                       String javaBeanCompatiblePropertyName = decapitalize(methodName.substring(3));</div><div class="line">                       field = ParserConfig.getFieldFromCache(javaBeanCompatiblePropertyName, fieldCacheMap);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               </div><div class="line">               JSONField fieldAnnotation = null;</div><div class="line">               if (field != null) &#123;</div><div class="line">                   fieldAnnotation = field.getAnnotation(JSONField.class);</div><div class="line"></div><div class="line">                   if (fieldAnnotation != null) &#123;</div><div class="line">                       if (!fieldAnnotation.serialize()) &#123;</div><div class="line">                           continue;</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       ordinal = fieldAnnotation.ordinal();</div><div class="line">                       serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</div><div class="line">                       parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</div><div class="line"></div><div class="line">                       if (fieldAnnotation.name().length() != 0) &#123;</div><div class="line">                           propertyName = fieldAnnotation.name();</div><div class="line"></div><div class="line">                           if (aliasMap != null) &#123;</div><div class="line">                               propertyName = aliasMap.get(propertyName);</div><div class="line">                               if (propertyName == null) &#123;</div><div class="line">                                   continue;</div><div class="line">                               &#125;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       if (fieldAnnotation.label().length() != 0) &#123;</div><div class="line">                           label = fieldAnnotation.label();</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               if (aliasMap != null) &#123;</div><div class="line">                   propertyName = aliasMap.get(propertyName);</div><div class="line">                   if (propertyName == null) &#123;</div><div class="line">                       continue;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               </div><div class="line">               if (propertyNamingStrategy != null) &#123;</div><div class="line">                   propertyName = propertyNamingStrategy.translate(propertyName);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               FieldInfo fieldInfo = new FieldInfo(propertyName, method, field, clazz, null, ordinal, serialzeFeatures, parserFeatures,</div><div class="line">                                                   annotation, fieldAnnotation, label);</div><div class="line">               fieldInfoMap.put(propertyName, fieldInfo);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           if (methodName.startsWith(&quot;is&quot;)) &#123;</div><div class="line">               if (methodName.length() &lt; 3) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               if (method.getReturnType() != Boolean.TYPE</div><div class="line">                       &amp;&amp; method.getReturnType() != Boolean.class) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               char c2 = methodName.charAt(2);</div><div class="line"></div><div class="line">               String propertyName;</div><div class="line">               if (Character.isUpperCase(c2)) &#123;</div><div class="line">                   if (compatibleWithJavaBean) &#123;</div><div class="line">                       propertyName = decapitalize(methodName.substring(2));</div><div class="line">                   &#125; else &#123;</div><div class="line">                       propertyName = Character.toLowerCase(methodName.charAt(2)) + methodName.substring(3);</div><div class="line">                   &#125;</div><div class="line">                   propertyName = getPropertyNameByCompatibleFieldName(fieldCacheMap, methodName,  propertyName,2); </div><div class="line">               &#125; else if (c2 == &apos;_&apos;) &#123;</div><div class="line">                   propertyName = methodName.substring(3);</div><div class="line">               &#125; else if (c2 == &apos;f&apos;) &#123;</div><div class="line">                   propertyName = methodName.substring(2);</div><div class="line">               &#125; else &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               Field field = ParserConfig.getFieldFromCache(propertyName,fieldCacheMap);</div><div class="line"></div><div class="line">               if (field == null) &#123;</div><div class="line">                   field = ParserConfig.getFieldFromCache(methodName,fieldCacheMap); </div><div class="line">               &#125;</div><div class="line"></div><div class="line">               JSONField fieldAnnotation = null;</div><div class="line">               if (field != null) &#123;</div><div class="line">                   fieldAnnotation = field.getAnnotation(JSONField.class);</div><div class="line"></div><div class="line">                   if (fieldAnnotation != null) &#123;</div><div class="line">                       if (!fieldAnnotation.serialize()) &#123;</div><div class="line">                           continue;</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       ordinal = fieldAnnotation.ordinal();</div><div class="line">                       serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</div><div class="line">                       parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</div><div class="line">                       </div><div class="line">                       if (fieldAnnotation.name().length() != 0) &#123;</div><div class="line">                           propertyName = fieldAnnotation.name();</div><div class="line"></div><div class="line">                           if (aliasMap != null) &#123;</div><div class="line">                               propertyName = aliasMap.get(propertyName);</div><div class="line">                               if (propertyName == null) &#123;</div><div class="line">                                   continue;</div><div class="line">                               &#125;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       if (fieldAnnotation.label().length() != 0) &#123;</div><div class="line">                           label = fieldAnnotation.label();</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               if (aliasMap != null) &#123;</div><div class="line">                   propertyName = aliasMap.get(propertyName);</div><div class="line">                   if (propertyName == null) &#123;</div><div class="line">                       continue;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               </div><div class="line">               if (propertyNamingStrategy != null) &#123;</div><div class="line">                   propertyName = propertyNamingStrategy.translate(propertyName);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               //优先选择get</div><div class="line">               if (fieldInfoMap.containsKey(propertyName)) &#123;</div><div class="line">                   continue;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               FieldInfo fieldInfo = new FieldInfo(propertyName, method, field, clazz, null, ordinal, serialzeFeatures, parserFeatures,</div><div class="line">                                                   annotation, fieldAnnotation, label);</div><div class="line">               fieldInfoMap.put(propertyName, fieldInfo);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>通过反射获取类的所有方法，并判断以get、is开头的方法。这个方法会假设 以get 、is 开头并符合一定规范的方法名后半部门上类的字段。 然后通过注解再进行一次过滤。如果bean对象中有这样的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class  Apple&#123;</div><div class="line">  private int a;</div><div class="line"> public void getOrange()&#123;</div><div class="line">  this.a=10</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那么 orange会被误以为是这个bean的filed。之后在write()方法的时候会调用所有filed的 get方法。那么 如果get方法里面有赋值操作，属性将会被重写。  bean对象在写get方法的时候一定要注意规范。要不然不注意的时候 对象就会被改动。</p>
<hr>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/11/spring自定义标签/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2017/09/27/fastjson序列化关于get方法/';
var disqus_title = 'fastjson序列化关于get方法';
var disqus_url = 'http://yoursite.com/2017/09/27/fastjson序列化关于get方法/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">席江平</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>